---
// Assets
import Logo from "@/components/assets/Logo.astro";
import { Image } from "astro:assets";
import LimeStripe from "@/images/assets/LimeStripe.png";
// Fundations
import AuthLayout from "@/layouts/AuthLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/elements/Button.astro";
// Icons

import ChevronLeft from "@/components/fundations/icons/ChevronLeft.astro";
---

<AuthLayout hideNav={true} hideFooter={true}>
  <div class="flex h-screen bg-white">
    <div
      class="flex items-center justify-center w-full p-8 bg-sand-50 lg:w-2/3"
    >
      <div class="w-full max-w-md py-24 lg:py-32">
        <div class="text-center">
          <a href="/"><Logo class="h-8 text-teal-600 mx-auto lg:mx-0" /></a>
          <div class="lg:text-balance text-center lg:text-left">
            <Text
              tag="h1"
              variant="displayMD"
              class="font-semibold tracking-tighter text-base-800 lg:text-balance mt-8"
            >
              Sign in
            </Text>
            <Text
              tag="p"
              variant="textBse"
              class="max-w-sm mt-4 font-medium text-base-500 md:text-balance"
            >
              Welcome back! Please enter your email and password to sign in.
            </Text>
          </div>
        </div>
        <form id="signin-form" class="mx-auto mt-12 max-w-lg">
          <div class="flex flex-col gap-y-4">
            <div>
              <label class="text-sm leading-normal text-base-500 font-medium">
                Email
              </label>
              <div class="mt-2.5">
                <input
                  type="email"
                  name="email"
                  id="email"
                  autocomplete="email"
                  required
                  aria-required="true"
                  aria-describedby="email-error"
                  placeholder="Your email"
                  class="block w-full h-10 px-4 py-2 text-sm text-teal-700 border border-transparent rounded-lg appearance-none duration-300 bg-base-100 placeholder-base-400 focus:bg-transparent focus:outline-none focus:ring-teal-500 focus:ring-offset-2 focus:ring-2 focus:ring-offset-base-200"
                />
                <span id="email-error" class="text-red-600 text-sm hidden">
                  Please enter a valid email address.
                </span>
              </div>
            </div>
            
            <!-- Success/Error Messages -->
            <div id="message" class="hidden">
              <div id="success-message" class="hidden p-3 rounded-lg bg-green-50 border border-green-200">
                <p class="text-sm text-green-800">
                  Check your email! We've sent you a magic link to sign in.
                </p>
              </div>
              <div id="error-message" class="hidden p-3 rounded-lg bg-red-50 border border-red-200">
                <p class="text-sm text-red-800" id="error-text">
                  Something went wrong. Please try again.
                </p>
              </div>
            </div>

            <Button type="submit" size="base" variant="default" class="w-full" id="signin-button">
              <span id="button-text">Send magic link</span>
              <span id="button-loading" class="hidden">Sending...</span>
            </Button>
          </div>
          <div class="flex items-center mt-4">
            <Text
              tag="p"
              variant="textSM"
              class="leading-normal text-base-500 font-medium"
            >
              Don't have an account?
              <a
                class="text-accent-500 font-medium hover:text-base-500"
                href="/auth/sign-up"
              >
                Sign up
              </a>
            </Text>
          </div>
        </form>

        <script>
          import { auth } from '../../lib/auth';

          document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('signin-form') as HTMLFormElement;
            const emailInput = document.getElementById('email') as HTMLInputElement;
            const messageDiv = document.getElementById('message');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const buttonText = document.getElementById('button-text');
            const buttonLoading = document.getElementById('button-loading');
            const signinButton = document.getElementById('signin-button') as HTMLButtonElement;

            // Check for URL parameters (error messages)
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            
            if (error) {
              showError(getErrorMessage(error));
            }

            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              
              const email = emailInput.value.trim();
              
              if (!email) {
                showError('Please enter your email address.');
                return;
              }

              if (!isValidEmail(email)) {
                showError('Please enter a valid email address.');
                return;
              }

              setLoading(true);
              hideMessages();

              try {
                const { data, error } = await auth.signInWithEmail(email);
                
                if (error) {
                  throw error;
                }

                showSuccess();
              } catch (error) {
                console.error('Sign in error:', error);
                showError(error.message || 'Failed to send magic link. Please try again.');
              } finally {
                setLoading(false);
              }
            });

            function setLoading(loading) {
              signinButton.disabled = loading;
              if (loading) {
                buttonText.classList.add('hidden');
                buttonLoading.classList.remove('hidden');
              } else {
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
              }
            }

            function showSuccess() {
              messageDiv.classList.remove('hidden');
              successMessage.classList.remove('hidden');
              errorMessage.classList.add('hidden');
            }

            function showError(message) {
              messageDiv.classList.remove('hidden');
              errorMessage.classList.remove('hidden');
              successMessage.classList.add('hidden');
              errorText.textContent = message;
            }

            function hideMessages() {
              messageDiv.classList.add('hidden');
              successMessage.classList.add('hidden');
              errorMessage.classList.add('hidden');
            }

            function isValidEmail(email) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              return emailRegex.test(email);
            }

            function getErrorMessage(error) {
              switch (error) {
                case 'verification_failed':
                  return 'Email verification failed. Please try again.';
                case 'no_session':
                  return 'No active session found. Please try signing in again.';
                case 'unexpected':
                  return 'An unexpected error occurred. Please try again.';
                default:
                  return 'An error occurred. Please try again.';
              }
            }
          });
        </script>
        <div class="mt-12">
          <Text
            href="/"
            tag="a"
            variant="textSM"
            class="flex items-center font-medium gap-2 text-base-800 group"
          >
            <ChevronLeft
              size="sm"
              class="duration-300 easy-out-in group-hover:-translate-x-2"
            /> Go back
          </Text>
        </div>
      </div>
    </div>
    <div
      class="relative hidden overflow-hidden lg:block lg:w-1/3 lg:order-first"
    >
      <Image
        src={LimeStripe}
        alt="Background"
        aria-hidden="true"
        width="1200"
        height="1200"
        loading="lazy"
        decoding="async"
        class="object-cover object-center w-full h-full bg-base-50"
      />
    </div>
  </div>
</AuthLayout>
