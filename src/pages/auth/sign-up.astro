---
// Assets
import Logo from "@/components/assets/Logo.astro";
import { Image } from "astro:assets";
import LimeStripe from "@/images/assets/LimeStripe.png";
// Fundations
import AuthLayout from "@/layouts/AuthLayout.astro";
import Text from "@/components/fundations/elements/Text.astro";
import Button from "@/components/fundations/elements/Button.astro";
// Icons
import ChevronLeft from "@/components/fundations/icons/ChevronLeft.astro";
---

<AuthLayout hideNav={true} hideFooter={true}>
  <div class="flex h-screen bg-white">
    <div
      class="flex items-center justify-center w-full p-8 bg-sand-50 lg:w-2/3"
    >
      <div class="w-full max-w-md py-24 lg:py-32">
        <div class="text-center">
          <a href="/"><Logo class="h-8 text-teal-600 mx-auto lg:mx-0" /></a>
          <div class="lg:text-balance text-center lg:text-left">
            <Text
              tag="h1"
              variant="displayMD"
              class="font-semibold tracking-tighter text-base-800 lg:text-balance mt-8"
            >
              Sign up
            </Text>
            <Text
              tag="p"
              variant="textBse"
              class="max-w-sm mt-4 font-medium text-base-500 md:text-balance"
            >
              Create an account wiht us.
            </Text>
          </div>
        </div>
        <form id="signup-form" class="mx-auto mt-12 max-w-lg">
          <div class="flex flex-col gap-y-4">
            <div>
              <label class="text-sm leading-normal text-base-500 font-medium">
                Email
              </label>
              <div class="mt-2.5">
                <input
                  type="email"
                  name="email"
                  id="email"
                  autocomplete="email"
                  required
                  aria-required="true"
                  aria-describedby="email-error"
                  placeholder="Your email"
                  class="block w-full h-10 px-4 py-2 text-sm text-teal-700 border border-transparent rounded-lg appearance-none duration-300 bg-base-100 placeholder-base-400 focus:bg-transparent focus:outline-none focus:ring-teal-500 focus:ring-offset-2 focus:ring-2 focus:ring-offset-base-200"
                />
                <span id="email-error" class="text-red-600 text-sm hidden">
                  Please enter a valid email address.
                </span>
              </div>
            </div>

            <!-- Success/Error Messages -->
            <div id="message" class="hidden">
              <div id="success-message" class="hidden p-3 rounded-lg bg-green-50 border border-green-200">
                <p class="text-sm text-green-800">
                  Check your email! We've sent you a magic link to complete your signup.
                </p>
              </div>
              <div id="error-message" class="hidden p-3 rounded-lg bg-red-50 border border-red-200">
                <p class="text-sm text-red-800" id="error-text">
                  Something went wrong. Please try again.
                </p>
              </div>
            </div>

            <div class="flex gap-3">
              <div class="flex h-6 shrink-0 items-center">
                <div class="group grid size-4 grid-cols-1">
                  <input
                    id="terms"
                    name="terms"
                    type="checkbox"
                    required
                    class="col-start-1 row-start-1 appearance-none rounded-sm border border-base-300 bg-white checked:border-teal-600 checked:bg-teal-600 indeterminate:border-teal-600 indeterminate:bg-teal-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-teal-600 disabled:border-base-300 disabled:bg-base-100 disabled:checked:bg-base-100 forced-colors:appearance-auto"
                  />
                  <svg
                    class="pointer-events-none col-start-1 row-start-1 size-3.5 self-center justify-self-center stroke-white group-has-disabled:stroke-base-850/25"
                    viewBox="0 0 14 14"
                    fill="none"
                  >
                    <path
                      class="opacity-0 group-has-checked:opacity-100"
                      d="M3 8L6 11L11 3.5"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"></path>
                    <path
                      class="opacity-0 group-has-indeterminate:opacity-100"
                      d="M3 7H11"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"></path>
                  </svg>
                </div>
              </div>
              <label for="terms" class="block text-sm/6 text-base-800">
                Creating an account means youâ€™re okay with our <a
                  class="text-base-500 hover:text-teal-600"
                  href="/infopages/terms">Terms</a
                > and
                <a
                  class="text-base-500 hover:text-teal-600"
                  href="/infopages/privacy"
                >
                  Privacy Policy</a
                > .
              </label>
            </div>
            <Button type="submit" size="base" variant="default" class="w-full" id="signup-button">
              <span id="button-text">Send magic link</span>
              <span id="button-loading" class="hidden">Sending...</span>
            </Button>
            <!-- <Button
              type="submit"
              size="base"
              variant="muted"
              gap="xs"
              class="w-full"
            >
              <svg
                class="size-4"
                fill="none"
                height="18"
                viewBox="0 0 32 32"
                width="24"
                xmlns="http://www.w3.org/2000/svg"
                ><path
                  d="M30.0014 16.3109C30.0014 15.1598 29.9061 14.3198 29.6998 13.4487H16.2871V18.6442H24.1601C24.0014 19.9354 23.1442 21.8798 21.2394 23.1864L21.2127 23.3604L25.4536 26.58L25.7474 26.6087C28.4458 24.1665 30.0014 20.5731 30.0014 16.3109Z"
                  fill="#4285F4"></path><path
                  d="M16.2862 30C20.1433 30 23.3814 28.7555 25.7465 26.6089L21.2386 23.1865C20.0322 24.011 18.4132 24.5866 16.2862 24.5866C12.5085 24.5866 9.30219 22.1444 8.15923 18.7688L7.9917 18.7827L3.58202 22.1272L3.52435 22.2843C5.87353 26.8577 10.6989 30 16.2862 30Z"
                  fill="#34A853"></path><path
                  d="M8.16007 18.7688C7.85848 17.8977 7.68395 16.9643 7.68395 15.9999C7.68395 15.0354 7.85849 14.1021 8.1442 13.231L8.13621 13.0455L3.67126 9.64734L3.52518 9.71544C2.55696 11.6132 2.0014 13.7444 2.0014 15.9999C2.0014 18.2555 2.55696 20.3865 3.52518 22.2843L8.16007 18.7688Z"
                  fill="#FBBC05"></path><path
                  d="M16.2863 7.4133C18.9688 7.4133 20.7783 8.54885 21.8101 9.4978L25.8418 5.64C23.3657 3.38445 20.1434 2 16.2863 2C10.699 2 5.87354 5.1422 3.52435 9.71549L8.14339 13.2311C9.30223 9.85555 12.5086 7.4133 16.2863 7.4133Z"
                  fill="#EB4335"></path>
              </svg>
              Sign up with Google
            </Button> -->
          </div>
          <div class="flex items-center mt-4">
            <Text
              tag="p"
              variant="textSM"
              class="leading-normal text-base-500 font-medium"
            >
              Already have an account?
              <a
                class="text-accent-500 font-medium hover:text-base-500"
                href="/auth/sign-in"
              >
                Sign in
              </a>
            </Text>
          </div>
        </form>

        <script>
          import { auth } from '../../lib/auth';

          document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('signup-form') as HTMLFormElement;
            const emailInput = document.getElementById('email') as HTMLInputElement;
            const termsInput = document.getElementById('terms') as HTMLInputElement;
            const messageDiv = document.getElementById('message');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const buttonText = document.getElementById('button-text');
            const buttonLoading = document.getElementById('button-loading');
            const signupButton = document.getElementById('signup-button') as HTMLButtonElement;

            form.addEventListener('submit', async (e) => {
              e.preventDefault();
              
              const email = emailInput.value.trim();
              
              if (!email) {
                showError('Please enter your email address.');
                return;
              }

              if (!isValidEmail(email)) {
                showError('Please enter a valid email address.');
                return;
              }

              if (!termsInput.checked) {
                showError('Please accept the Terms and Privacy Policy.');
                return;
              }

              setLoading(true);
              hideMessages();

              try {
                const { data, error } = await auth.signUpWithEmail(email);
                
                if (error) {
                  throw error;
                }

                showSuccess();
              } catch (error) {
                console.error('Sign up error:', error);
                showError(error.message || 'Failed to send magic link. Please try again.');
              } finally {
                setLoading(false);
              }
            });

            function setLoading(loading) {
              signupButton.disabled = loading;
              if (loading) {
                buttonText.classList.add('hidden');
                buttonLoading.classList.remove('hidden');
              } else {
                buttonText.classList.remove('hidden');
                buttonLoading.classList.add('hidden');
              }
            }

            function showSuccess() {
              messageDiv.classList.remove('hidden');
              successMessage.classList.remove('hidden');
              errorMessage.classList.add('hidden');
            }

            function showError(message) {
              messageDiv.classList.remove('hidden');
              errorMessage.classList.remove('hidden');
              successMessage.classList.add('hidden');
              errorText.textContent = message;
            }

            function hideMessages() {
              messageDiv.classList.add('hidden');
              successMessage.classList.add('hidden');
              errorMessage.classList.add('hidden');
            }

            function isValidEmail(email) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              return emailRegex.test(email);
            }
          });
        </script>

        <div class="mt-12">
          <Text
            href="/"
            tag="a"
            variant="textSM"
            class="flex items-center font-medium gap-2 text-base-800 group"
          >
            <ChevronLeft
              size="sm"
              class="duration-300 easy-out-in group-hover:-translate-x-2"
            /> Go back
          </Text>
        </div>
      </div>
    </div>
    <div
      class="relative hidden overflow-hidden lg:block lg:w-1/3 lg:order-first"
    >
      <Image
        src={LimeStripe}
        alt="Background"
        aria-hidden="true"
        width="1200"
        height="1200"
        loading="lazy"
        decoding="async"
        class="object-cover object-center w-full h-full bg-base-50"
      />
    </div>
  </div>
</AuthLayout>
