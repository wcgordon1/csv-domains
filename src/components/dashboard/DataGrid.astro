---
import Text from "@/components/fundations/elements/Text.astro";
---

<!-- Data Grid - Table display with sorting, selection, and editing -->
<div class="border border-base-200 rounded-lg" id="data-grid-container">
  <!-- Loading state -->
  <div id="grid-loading" class="p-8 text-center">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600 mx-auto mb-4"></div>
    <Text tag="p" variant="textSM" class="text-base-600">
      Waiting for CSV data...
    </Text>
  </div>

  <!-- Bulk Actions - Fixed at top, full width -->
  <div id="bulk-actions" class="hidden bg-base-50 border-b border-base-200 px-4 py-3 w-full">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <Text tag="span" variant="textSM" class="text-base-600" id="selected-count">
          0 rows selected
        </Text>
      </div>
      <div class="flex items-center space-x-2">
        <button id="bulk-edit-btn" class="hidden px-3 py-1 text-sm text-teal-600 hover:text-teal-700 border border-teal-300 rounded hover:bg-teal-50 cursor-pointer whitespace-nowrap">
          Edit All
        </button>
        <button id="bulk-delete-btn" class="hidden px-3 py-1 text-sm text-red-600 hover:text-red-700 border border-red-300 rounded hover:bg-red-50 cursor-pointer whitespace-nowrap">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Scrollable table container -->
  <div class="overflow-x-auto relative">
    <!-- Data grid table -->
    <table id="data-grid-table" class="min-w-full divide-y divide-base-200 hidden">
      <thead class="bg-base-50" id="data-grid-header">
        <!-- Headers will be dynamically generated -->
      </thead>
      <tbody id="data-grid-body" class="bg-white divide-y divide-base-200">
        <!-- Rows will be dynamically generated -->
      </tbody>
    </table>
    
    <!-- Sorting loading overlay -->
    <div id="sort-loading" class="hidden absolute backdrop-blur-sm bg-white/30 z-10 left-0 right-0 bottom-0">
      <div class="flex items-center justify-center h-full min-h-[100px]">
        <Text tag="p" variant="textSM" class="text-base-700 font-medium">
          Sorting data...
        </Text>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div id="grid-empty" class="hidden p-8 text-center">
    <Text tag="p" variant="textBase" class="text-base-600">
      No data to display. Upload a CSV file to get started.
    </Text>
  </div>
</div>

<!-- Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
      <div class="flex justify-between items-center mb-4">
        <Text tag="h3" variant="textLG" class="font-semibold text-base-800" id="modal-title">
          Edit Row
        </Text>
        <button id="close-modal-btn" class="text-base-400 hover:text-base-600 cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <form id="edit-form" class="space-y-4">
        <input type="hidden" id="edit-row-index" />
        <input type="hidden" id="edit-mode" value="single" />
        <div id="edit-fields-container" class="space-y-4">
          <!-- Fields will be dynamically generated based on current format -->
        </div>
        
        <div class="flex justify-end space-x-3 pt-4 border-t border-base-200">
          <button type="button" id="cancel-edit-btn" class="px-4 py-2 text-sm text-base-600 border border-base-300 rounded-md hover:bg-base-50 cursor-pointer">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 text-sm text-white bg-teal-600 border border-transparent rounded-md hover:bg-teal-700 cursor-pointer">
            <span id="save-btn-text">Save Changes</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  import type { CSVData } from '../../lib/csvProcessor';
  import { getFormat } from '../../lib/formatConfigs.js';

  let displayData: CSVData = { headers: [], rows: [] };
  let currentFormat = 'afternic';
  let selectedRows = new Set<number>();
  let currentSort: { column: string | null; direction: 'asc' | 'desc' | null } = { column: null, direction: null };

  document.addEventListener('DOMContentLoaded', () => {
    const gridLoading = document.getElementById('grid-loading');
    const gridTable = document.getElementById('data-grid-table');
    const gridEmpty = document.getElementById('grid-empty');
    const gridHeader = document.getElementById('data-grid-header');
    const gridBody = document.getElementById('data-grid-body');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    const editModal = document.getElementById('edit-modal');

    // Listen for display data ready
    window.addEventListener('display-data-ready', (event: any) => {
      displayData = event.detail.data;
      currentFormat = event.detail.format;
      
      // Reset sort state when new data is loaded
      currentSort = { column: null, direction: null };
      selectedRows.clear();
      
      renderGrid();
    });

    // Listen for processing overlay events (price increases, etc.)
    window.addEventListener('show-processing-overlay', (event: any) => {
      const message = event.detail?.message || 'Processing data...';
      showProcessingLoading(message);
    });

    window.addEventListener('hide-processing-overlay', () => {
      hideProcessingLoading();
    });

    // Bulk action handlers
    document.getElementById('bulk-delete-btn')?.addEventListener('click', deleteSelected);
    document.getElementById('bulk-edit-btn')?.addEventListener('click', editSelected);

    // Modal handlers
    document.getElementById('close-modal-btn')?.addEventListener('click', closeModal);
    document.getElementById('cancel-edit-btn')?.addEventListener('click', closeModal);
    document.getElementById('edit-form')?.addEventListener('submit', saveEdit);

    function renderGrid() {
      if (!gridBody || !gridHeader) return;

      if (displayData.rows.length === 0) {
        showEmpty();
        return;
      }

      showTable();
      
      // Render headers
      renderHeaders();
      
      // Clear existing rows
      gridBody.innerHTML = '';

      // Render data rows
      displayData.rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-base-50';
        
        // Checkbox column
        const checkboxTd = document.createElement('td');
        checkboxTd.className = 'px-3 py-4 whitespace-nowrap text-sm text-base-900 sticky left-0 bg-white border-r border-base-200';
        checkboxTd.innerHTML = `<input type="checkbox" class="row-checkbox" data-index="${index}" />`;
        tr.appendChild(checkboxTd);
        
        // Data columns
        displayData.headers.forEach(header => {
          const td = document.createElement('td');
          td.className = 'px-3 py-4 whitespace-nowrap text-sm text-base-900';
          const value = row[header] || '';
          
          // Format Y/N values with badges
          if (value.toUpperCase() === 'Y' || value.toUpperCase() === 'N') {
            const badgeColor = value.toUpperCase() === 'Y' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">${value.toUpperCase()}</span>`;
          } 
          // Format On/Off values with badges (for Spaceship)
          else if (value === 'On' || value === 'Off') {
            const badgeColor = value === 'On' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
            td.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeColor}">${value}</span>`;
          } else {
            td.textContent = value;
          }
          
          tr.appendChild(td);
        });
        
        // Actions column
        const actionsTd = document.createElement('td');
        actionsTd.className = 'px-3 py-4 whitespace-nowrap text-sm text-base-900';
        actionsTd.innerHTML = `<button class="edit-btn text-teal-600 hover:text-teal-700" data-index="${index}">Edit</button>`;
        tr.appendChild(actionsTd);
        
        gridBody.appendChild(tr);
      });

      // Add event listeners
      document.querySelectorAll('.row-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleRowSelection);
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const index = parseInt(target.dataset.index || '0');
          openEditModal(index);
        });
      });

      // Add master checkbox event listener
      const masterCheckbox = document.getElementById('master-checkbox') as HTMLInputElement;
      masterCheckbox?.addEventListener('change', handleMasterCheckbox);

      updateSelectionUI();
    }

    function renderHeaders() {
      if (!gridHeader) return;
      
      gridHeader.innerHTML = '';
      const tr = document.createElement('tr');
      
      // Checkbox header
      const checkboxTh = document.createElement('th');
      checkboxTh.className = 'px-3 py-3 text-left text-xs font-medium text-base-500 uppercase tracking-wider sticky left-0 bg-base-50 border-r border-base-200';
      checkboxTh.innerHTML = '<input type="checkbox" id="master-checkbox" class="cursor-pointer" />';
      tr.appendChild(checkboxTh);
      
      // Data headers
      displayData.headers.forEach(header => {
        const th = document.createElement('th');
        th.className = 'px-3 py-3 text-left text-xs font-medium text-base-500 uppercase tracking-wider min-w-[120px] cursor-pointer hover:bg-base-100 select-none';
        th.innerHTML = `${header}${getSortArrow(header)}`;
        th.addEventListener('click', () => sortByColumn(header));
        tr.appendChild(th);
      });
      
      // Actions header
      const actionsTh = document.createElement('th');
      actionsTh.className = 'px-3 py-3 text-left text-xs font-medium text-base-500 uppercase tracking-wider w-[80px]';
      actionsTh.textContent = 'Actions';
      tr.appendChild(actionsTh);
      
      gridHeader.appendChild(tr);
    }

    function showTable() {
      gridLoading?.classList.add('hidden');
      gridEmpty?.classList.add('hidden');
      gridTable?.classList.remove('hidden');
      bulkActions?.classList.remove('hidden');
    }

    function showEmpty() {
      gridLoading?.classList.add('hidden');
      gridTable?.classList.add('hidden');
      bulkActions?.classList.add('hidden');
      gridEmpty?.classList.remove('hidden');
    }

    function handleRowSelection(event: Event) {
      const target = event.target as HTMLInputElement;
      const index = parseInt(target.dataset.index || '0');
      
      if (target.checked) {
        selectedRows.add(index);
      } else {
        selectedRows.delete(index);
      }
      
      updateSelectionUI();
      
      // Update global state
      (window as any).updateSelectedRows?.(selectedRows);
    }

    function updateSelectionUI() {
      const bulkEditBtn = document.getElementById('bulk-edit-btn');
      const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
      const masterCheckbox = document.getElementById('master-checkbox') as HTMLInputElement;
      
      if (selectedCount) {
        selectedCount.textContent = `${selectedRows.size} rows selected`;
      }
      
      // Update master checkbox state
      if (masterCheckbox) {
        if (selectedRows.size === 0) {
          masterCheckbox.checked = false;
          masterCheckbox.indeterminate = false;
        } else if (selectedRows.size === displayData.rows.length) {
          masterCheckbox.checked = true;
          masterCheckbox.indeterminate = false;
        } else {
          masterCheckbox.checked = false;
          masterCheckbox.indeterminate = true;
        }
      }
      
      // Show/hide buttons based on selection count
      if (selectedRows.size > 0) {
        bulkEditBtn?.classList.remove('hidden');
        bulkDeleteBtn?.classList.remove('hidden');
      } else {
        bulkEditBtn?.classList.add('hidden');
        bulkDeleteBtn?.classList.add('hidden');
      }
    }

    function handleMasterCheckbox(event: Event) {
      const target = event.target as HTMLInputElement;
      
      if (target.checked) {
        // Select all
        selectedRows.clear();
        for (let i = 0; i < displayData.rows.length; i++) {
          selectedRows.add(i);
        }
        
        document.querySelectorAll('.row-checkbox').forEach((checkbox: any) => {
          checkbox.checked = true;
        });
      } else {
        // Deselect all
        selectedRows.clear();
        
        document.querySelectorAll('.row-checkbox').forEach((checkbox: any) => {
          checkbox.checked = false;
        });
      }
      
      updateSelectionUI();
      (window as any).updateSelectedRows?.(selectedRows);
    }

    function sortByColumn(column: string) {
      // Don't sort Actions column
      if (column === 'Actions') return;

      // Show loading spinner with sorting message
      showProcessingLoading('Sorting data...');

      // Use setTimeout to allow UI update
      setTimeout(() => {
        // Toggle sort direction
        if (currentSort.column === column) {
          if (currentSort.direction === 'asc') {
            currentSort.direction = 'desc';
          } else if (currentSort.direction === 'desc') {
            currentSort.column = null;
            currentSort.direction = null;
          }
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }

        // Sort and re-render
        applySorting();
        renderGrid();
        hideProcessingLoading();
      }, 100);
    }

    function applySorting() {
      if (!currentSort.column || !currentSort.direction) return;

      const column = currentSort.column;
      const direction = currentSort.direction;

      displayData.rows.sort((a, b) => {
        const aValue = a[column] || '';
        const bValue = b[column] || '';

        // Detect numeric values
        const aIsNumeric = !isNaN(parseFloat(aValue.toString().replace(/[,$]/g, ''))) && isFinite(parseFloat(aValue.toString().replace(/[,$]/g, '')));
        const bIsNumeric = !isNaN(parseFloat(bValue.toString().replace(/[,$]/g, ''))) && isFinite(parseFloat(bValue.toString().replace(/[,$]/g, '')));

        let comparison = 0;

        if (aIsNumeric && bIsNumeric) {
          const aNum = parseFloat(aValue.toString().replace(/[,$]/g, ''));
          const bNum = parseFloat(bValue.toString().replace(/[,$]/g, ''));
          comparison = aNum - bNum;
        } else {
          comparison = aValue.toString().localeCompare(bValue.toString(), undefined, { 
            numeric: true, 
            sensitivity: 'base' 
          });
        }

        return direction === 'asc' ? comparison : -comparison;
      });

      // Clear selections after sorting to avoid confusion
      selectedRows.clear();
      updateSelectionUI();
    }

    function getSortArrow(column: string): string {
      if (currentSort.column !== column) {
        return `<span class="ml-1 text-base-400">↕</span>`;
      }
      
      if (currentSort.direction === 'asc') {
        return `<span class="ml-1 text-base-600">↑</span>`;
      } else if (currentSort.direction === 'desc') {
        return `<span class="ml-1 text-base-600">↓</span>`;
      }
      
      return `<span class="ml-1 text-base-400">↕</span>`;
    }

    function showProcessingLoading(message: string = 'Processing data...') {
      const sortLoading = document.getElementById('sort-loading');
      const gridHeader = document.getElementById('data-grid-header');
      
      if (sortLoading && gridHeader) {
        // Update the loading message
        const loadingText = sortLoading.querySelector('p');
        if (loadingText) {
          loadingText.textContent = message;
        }
        
        // Calculate header height dynamically
        const headerHeight = gridHeader.offsetHeight;
        sortLoading.style.top = `${headerHeight}px`;
        sortLoading.classList.remove('hidden');
      }
    }

    function hideProcessingLoading() {
      const sortLoading = document.getElementById('sort-loading');
      sortLoading?.classList.add('hidden');
      
      // Reset loading text back to sorting message
      const loadingText = sortLoading?.querySelector('p');
      if (loadingText) {
        loadingText.textContent = 'Sorting data...';
      }
    }

    function deleteSelected() {
      if (selectedRows.size === 0) return;
      
      if (confirm(`Are you sure you want to delete ${selectedRows.size} rows?`)) {
        const sortedIndices = Array.from(selectedRows).sort((a, b) => b - a);
        
        sortedIndices.forEach(index => {
          displayData.rows.splice(index, 1);
        });
        
        selectedRows.clear();
        renderGrid();
        
        // Notify container of data update
        window.dispatchEvent(new CustomEvent('csv-data-updated', { 
          detail: { data: displayData, format: currentFormat } 
        }));
      }
    }

    function editSelected() {
      if (selectedRows.size === 0) return;
      
      if (selectedRows.size === 1) {
        const index = Array.from(selectedRows)[0];
        openEditModal(index);
      } else {
        openBulkEditModal();
      }
    }

    function openEditModal(index: number) {
      const row = displayData.rows[index];
      if (!row) return;

      const modalTitle = document.getElementById('modal-title');
      const saveBtnText = document.getElementById('save-btn-text');
      const editMode = document.getElementById('edit-mode') as HTMLInputElement;
      const format = getFormat(currentFormat);
      
      if (modalTitle) modalTitle.textContent = `${format.displayName} Edit: 1 row`;
      if (saveBtnText) saveBtnText.textContent = 'Save Changes';
      if (editMode) editMode.value = 'single';

      // Populate form
      (document.getElementById('edit-row-index') as HTMLInputElement).value = index.toString();
      
      // Generate dynamic form fields based on current format
      generateEditForm(false, row);

      editModal?.classList.remove('hidden');
    }

    function openBulkEditModal() {
      const modalTitle = document.getElementById('modal-title');
      const saveBtnText = document.getElementById('save-btn-text');
      const editMode = document.getElementById('edit-mode') as HTMLInputElement;
      const format = getFormat(currentFormat);
      
      if (modalTitle) modalTitle.textContent = `${format.displayName} Edit: ${selectedRows.size} rows`;
      if (saveBtnText) saveBtnText.textContent = 'Update All Selected';
      if (editMode) editMode.value = 'bulk';
      
      // Generate form fields with empty values for bulk editing
      generateEditForm(true);

      editModal?.classList.remove('hidden');
    }

    function generateEditForm(isBulkEdit: boolean, row?: any) {
      const fieldsContainer = document.getElementById('edit-fields-container');
      if (!fieldsContainer) return;
      
      fieldsContainer.innerHTML = '';
      
      // Get current format configuration
      const format = getFormat(currentFormat);
      
      // Add notice for bulk editing
      if (isBulkEdit) {
        const notice = document.createElement('div');
        notice.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4';
        notice.innerHTML = `
          <div class="flex">
            <svg class="h-5 w-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="ml-3">
              <p class="text-sm text-blue-800">
                <strong>Bulk Edit Mode:</strong> Only fill in the fields you want to update. Empty fields will remain unchanged for all selected rows.
              </p>
            </div>
          </div>
        `;
        fieldsContainer.appendChild(notice);
      }
      
      // Create form fields based on format configuration
      const editableColumns = format.columns; // Include all columns now that Currency/ActionType are editable
      
      // Process columns in pairs for two-column layout
      for (let i = 0; i < editableColumns.length; i += 2) {
        const column1 = editableColumns[i];
        const column2 = editableColumns[i + 1];
        
        if (column2) {
          // Create a row with two columns
          const rowDiv = document.createElement('div');
          rowDiv.className = 'grid grid-cols-2 gap-4';
          
          const firstFieldDiv = createFieldElement(column1, isBulkEdit, row);
          const secondFieldDiv = createFieldElement(column2, isBulkEdit, row);
          
          rowDiv.appendChild(firstFieldDiv);
          rowDiv.appendChild(secondFieldDiv);
          fieldsContainer.appendChild(rowDiv);
        } else {
          // Single column for the last field if odd number of fields
          const singleFieldDiv = createFieldElement(column1, isBulkEdit, row);
          fieldsContainer.appendChild(singleFieldDiv);
        }
      }
    }

    function createFieldElement(column: any, isBulkEdit: boolean, row?: any) {
      const fieldDiv = document.createElement('div');
      const label = document.createElement('label');
      label.className = 'block text-sm font-medium text-base-700 mb-1';
      label.textContent = column.displayName;

      const fieldId = `edit-field-${column.key}`;
      
      if (column.type === 'select') {
        // Create dropdown field
        const select = document.createElement('select');
        select.id = fieldId;
        select.className = 'w-full px-3 py-2 border border-base-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500';
        
        // Add blank option for bulk edit
        if (isBulkEdit) {
          const blankOption = document.createElement('option');
          blankOption.value = '';
          blankOption.textContent = 'Keep current values';
          select.appendChild(blankOption);
        }
        
        // Add options from column configuration
        if (column.options) {
          column.options.forEach((optionValue: string) => {
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue || '(Empty)';
            select.appendChild(option);
          });
        }
        
        // Set current value for single edit
        if (!isBulkEdit && row) {
          const currentValue = row[column.displayName];
          if (currentValue !== undefined) {
            select.value = currentValue;
          }
        }

        fieldDiv.appendChild(label);
        fieldDiv.appendChild(select);
        
      } else if (column.type === 'number') {
        // Create number input field
        const input = document.createElement('input');
        input.type = 'number';
        input.id = fieldId;
        input.className = 'w-full px-3 py-2 border border-base-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500';
        input.placeholder = isBulkEdit ? 'Leave blank to keep current values' : '';
        
        // Add min/max constraints if specified
        if (column.min !== undefined) input.min = column.min.toString();
        if (column.max !== undefined) input.max = column.max.toString();
        
        // Set current value for single edit
        if (!isBulkEdit && row) {
          const currentValue = row[column.displayName];
          if (currentValue !== undefined && currentValue !== '') {
            input.value = currentValue.toString();
          }
        }

        // Add validation for Max Lease Period (if it exists in current format)
        if (column.key === 'maxLeasePeriod') {
          input.addEventListener('input', function() {
            const value = parseInt(this.value);
            const errorDiv = document.getElementById(`error-${column.key}`);
            
            if (this.value && (isNaN(value) || value < 2 || value > 60)) {
              this.className = 'w-full px-3 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500';
              if (!errorDiv) {
                const error = document.createElement('div');
                error.id = `error-${column.key}`;
                error.className = 'text-red-600 text-xs mt-1';
                error.textContent = 'Needs to be a value between 2 - 60';
                fieldDiv.appendChild(error);
              }
            } else {
              this.className = 'w-full px-3 py-2 border border-base-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500';
              if (errorDiv) {
                errorDiv.remove();
              }
            }
          });
        }

        fieldDiv.appendChild(label);
        fieldDiv.appendChild(input);
        
      } else {
        // Create text input field (default)
        const input = document.createElement('input');
        input.type = 'text';
        input.id = fieldId;
        input.className = 'w-full px-3 py-2 border border-base-300 rounded-md focus:outline-none focus:ring-2 focus:ring-teal-500';
        input.placeholder = isBulkEdit ? 'Leave blank to keep current values' : '';
        
        // Set current value for single edit
        if (!isBulkEdit && row) {
          const currentValue = row[column.displayName];
          if (currentValue !== undefined) {
            input.value = currentValue.toString();
          }
        }

        fieldDiv.appendChild(label);
        fieldDiv.appendChild(input);
      }

      return fieldDiv;
    }

    function closeModal() {
      editModal?.classList.add('hidden');
    }

    function saveEdit(event: Event) {
      event.preventDefault();
      
      const editMode = (document.getElementById('edit-mode') as HTMLInputElement).value;
      const format = getFormat(currentFormat);
      
      if (editMode === 'bulk') {
        // Bulk edit mode
        const updates: { [key: string]: string } = {};
        
        // Collect non-empty values from form fields
        format.columns.forEach(column => {
          const element = document.getElementById(`edit-field-${column.key}`) as HTMLInputElement | HTMLSelectElement;
          if (element && element.value.trim() !== '') {
            updates[column.displayName] = element.value.trim();
          }
        });

        // Apply updates to all selected rows
        selectedRows.forEach(index => {
          Object.keys(updates).forEach(displayName => {
            displayData.rows[index][displayName] = updates[displayName];
          });
        });
        
        selectedRows.clear();
      } else {
        // Single edit mode
        const index = parseInt((document.getElementById('edit-row-index') as HTMLInputElement).value);
        
        const updatedRow: any = {};
        
        // Collect values from all dynamic fields
        format.columns.forEach(column => {
          const element = document.getElementById(`edit-field-${column.key}`) as HTMLInputElement | HTMLSelectElement;
          if (element) {
            updatedRow[column.displayName] = element.value.trim();
          } else if (!column.sourceColumn) {
            // For fields without source column (like Currency/Action Type), default to empty if no element found
            updatedRow[column.displayName] = '';
          }
        });

        displayData.rows[index] = updatedRow;
      }

      renderGrid();
      closeModal();

      // Notify container of data update
      window.dispatchEvent(new CustomEvent('csv-data-updated', { 
        detail: { data: displayData, format: currentFormat } 
      }));
    }
  });
</script>
</script>